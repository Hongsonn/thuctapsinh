# Hướng dẫn đóng image Window server 2012 R2 Standar với cloud-init và QEMU Guest Agent 

## Bước 1: Tạo máy bằng KVM
Sử dụng WebvirtCloud để cài máy ảo

## Bước 2: Xử lý image sau khi cài xong OS
### 2.1. Tạo password Administrator cho máy ảo
<img src="..\images\Screenshot_45.png">

### 2.2. Đăng nhập vào máy ảo
Nháy chọn **Send CtrAltDel**

<img src="..\images\Screenshot_46.png">

Nhập mật khẩu vừa tạo vào để đăng nhập

<img src="..\images\Screenshot_47.png">

### 2.3. Cài đặt driver mạng
Vào **Device Manager** và thực hiện như sau:

<img src="..\images\Screenshot_48.png">

<img src="..\images\Screenshot_49.png">

Chọn từ ổ đĩa vitio đã mount theo đường dẫn:

<img src="..\images\Screenshot_50.png">

<img src="..\images\Screenshot_51.png">

<img src="..\images\Screenshot_52.png">

Kiểm tra:

<img src="..\images\Screenshot_53.png">

### 2.4. Cài đặt Baloon driver cho Memory
Copy `/virtio-win-0.1.1/Baloon/2k12R2/amd64` từ CD Drive vào `C:\`

<img src="..\images\Screenshot_54.png">

Chạy PowerShell, trỏ về thư mục `amd64` vừa copy và chạy lệnh:
```
cd C:\amd64

.\blnsvr.exe -i
```

<img src="..\images\Screenshot_55.png">

Kiểm tra trong `services.msc`

<img src="..\images\Screenshot_56.png">

### 2.5. Cài đặt Baloon driver cho CPU
Update driver **PCI device**

<img src="..\images\Screenshot_57.png">

<img src="..\images\Screenshot_58.png">

<img src="..\images\Screenshot_59.png">

Kiểm tra

<img src="..\images\Screenshot_60.png">

Tiếp tục update driver cho **PCI Simple Communication Controller**

<img src="..\images\Screenshot_61.png">

<img src="..\images\Screenshot_62.png">

Kiểm tra 

<img src="..\images\Screenshot_63.png">

### 2.6. Cài đặt QEMU-Agent
Truy cập ổ CD-rom chạy file: **Virtio-win-0.1.1** -> **guest-agent** -> **qemu-ga-x64**

<img src="..\images\Screenshot_64.png">

Kiểm tra trên PowerShell
```
Get-Service QEMU-GA
```

<img src="..\images\Screenshot_65.png">

Kiểm tra lại version của `qemu-guest-agent` (phải đảm bảo version >= 7.3.2)

<img src="..\images\Screenshot_66.png">

### 2.7. Disable firewall và Enable remote desktop
Disable Firewall

<img src="..\images\Screenshot_67.png">

Enable Remote Desktop

<img src="..\images\Screenshot_68.png">


### 2.8. Cài đặt thời gian
Đặt lại múi giờ và chỉnh thời gian cho đúng

<img src="..\images\Screenshot_69.png">

### 2.9. Cài đặt Cloud-init
Vào PowerShell, tắt mode cập nhật policy đảm bảo cho Cloud-init có thể hoạt động:
```
Set-ExecutionPolicy Unrestricted
```

<img src="..\images\Screenshot_70.png">

